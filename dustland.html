<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dustland: CRT Edition</title>
  <link rel="stylesheet" href="dustland.css" />
</head>
<body>
  <div id="nanoStatus">
    <div id="nanoProgress" class="nano-progress"></div>
    <div id="nanoBadge" class="nano-badge off">✗</div>
  </div>
  <div class="wrap">
    <div class="crt-wrap" style="flex:1;display:flex;align-items:center;justify-content:center">
      <div class="tube">
        <canvas id="game" width="640" height="480" class="glow" aria-label="Dustland CRT"></canvas>
      </div>
    </div>
    <aside class="panel">
      <h1>DUSTLAND // CRT v0.6.7</h1>
      <div class="content" id="log"></div>
      <div class="content">
        <div class="hud">
          <div class="badge">HP: <span id="hp">10</span></div>
          <div class="badge">AP: <span id="ap">2</span></div>
          <div class="badge">Scrap: <span id="scrap">0</span></div>
          <div class="badge">Map: <span id="mapname">—</span></div>
        </div>
        <p class="muted" style="margin-top:10px">Controls: <b>WASD/Arrows</b> move • <b>E/Space</b> interact/door & take nearby item • <b>T/G</b> take item • <b>I</b> Inventory • <b>P</b> Party • <b>Q</b> Quests • <b>O</b> audio • <b>C</b> mobile controls • <b>M</b> minimap • <b>Esc</b> close</p>
        <div class="tabs">
          <div class="tab active" id="tabInv">Inventory</div>
          <div class="tab" id="tabParty">Party</div>
          <div class="tab" id="tabQuests">Quests</div>
        </div>
        <div class="tabwrap" id="tabWrap">
          <div id="inv"></div>
          <div id="party" style="display:none"></div>
          <div id="quests" style="display:none"></div>
        </div>
        <div style="margin-top:8px" id="mainButtons">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn" id="loadBtn">Load</button>
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn" id="settingsBtn">Settings</button>
        </div>
        </div>
      </aside>
    </div>

  <div id="panelToggle">☰</div>

  <!-- Settings Panel -->
  <div id="settings">
    <div class="win">
      <header>Settings</header>
      <main>
        <button class="btn" id="nanoToggle">Nano Dialog</button>
        <button class="btn" id="audioToggle">Audio: On</button>
        <button class="btn" id="mobileToggle">Mobile Controls: Off</button>
        <button class="btn" id="settingsClose">Close</button>
      </main>
    </div>
  </div>

  <!-- Start Menu -->
  <div id="start">
    <div class="win">
      <header>Dustland — Start</header>
      <main>
        <p class="muted">Continue your journey or start a new game?</p>
        <div>
          <button class="btn" id="startContinue">Continue</button>
          <button class="btn" id="startNew">New Game</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Dialog overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <header>
        <div class="portrait" id="port"></div>
        <div><div id="npcName" style="font-weight:700"></div><div class="small" id="npcTitle"></div></div>
      </header>
      <main id="dialogText"></main>
      <div class="choices" id="choices"></div>
    </div>
  </div>

  <!-- Combat overlay -->
  <div class="overlay" id="combatOverlay" role="dialog" aria-modal="true">
    <div class="combat-window">
      <div class="battlefield">
        <div class="enemy-row" id="combatEnemies"></div>
        <div class="party-row" id="combatParty"></div>
      </div>
      <div class="command-row">
        <div class="turn" id="turnIndicator"></div>
        <div class="cmd" id="combatCmd"></div>
      </div>
    </div>
  </div>

  <!-- Character Creator -->
  <div id="creator" style="display:none">
    <div class="win">
      <header>
        <div><b>Dustland: Party Creation</b> — <span id="ccStep">1</span>/5</div>
        <div class="small">Create up to 3 drifters (or start now)</div>
      </header>
      <main>
        <div class="pbox">
          <div class="p" id="ccPortrait"></div>
        </div>
        <div id="ccRight"></div>
      </main>
      <div class="footer">
        <div class="small" id="ccHint">Pick a name and portrait.</div>
        <div class="right">
          <button class="btn" id="ccLoad">Load Game</button>
          <button class="btn" id="ccStart">Start Now</button>
          <button class="btn" id="ccBack">Back</button>
          <button class="btn btn--primary" id="ccNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Module Loader -->
  <div id="moduleLoader" style="position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:40">
    <div class="win" style="width:min(420px,92vw);background:#0b0d0b;border:1px solid #2a382a;border-radius:12px;box-shadow:0 20px 80px rgba(0,0,0,.7);overflow:hidden">
      <header style="padding:10px 12px;border-bottom:1px solid #223022;font-weight:700">Load Adventure Module</header>
      <main style="padding:12px">
        <p class="muted" style="margin-bottom:8px">Load a module from the web or a local JSON file.</p>
        <input type="text" id="modUrl" value="modules/golden.module.json" style="width:100%" />
        <button class="btn" id="modUrlBtn" style="margin-top:8px">Load from URL</button>
        <hr style="margin:12px 0" />
        <input type="file" id="modFile" accept="application/json" />
        <button class="btn" id="modFileBtn" style="margin-top:8px">Load from File</button>
      </main>
    </div>
  </div>

  <script defer src="./event-bus.js"></script>
  <script defer src="./core/effects.js"></script>
  <script defer src="./core/inventory.js"></script>
  <script defer src="./core/actions.js"></script>
  <script defer src="./core/movement.js"></script>
  <script defer src="./core/dialog.js"></script>
  <script defer src="./core/combat.js"></script>
  <script defer src="./core/party.js"></script>
  <script defer src="./core/quests.js"></script>
  <script defer src="./core/npc.js"></script>
  <script defer src="./dustland-core.js"></script>
  <script defer src="./dustland-path.js"></script>
  <script defer src="./dustland-nano.js"></script>
  <script defer src="./dustland-engine.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const isAck = params.get('ack-player') === '1';
    if (isAck) {
      document.getElementById('moduleLoader').style.display = 'flex';
      const btns = document.getElementById('mainButtons');
      const nanoBtn = document.getElementById('nanoToggle');
      const audioBtn = document.getElementById('audioToggle');
      btns.appendChild(nanoBtn);
      btns.appendChild(audioBtn);
      const settingsBtn = document.getElementById('settingsBtn');
      if (settingsBtn) settingsBtn.style.display = 'none';
    }
    const modeScript = document.createElement('script');
    modeScript.defer = true;
    modeScript.src = isAck ? './ack-player.js' : './module-picker.js';
    document.body.appendChild(modeScript);
  </script>
</body>
</html>
