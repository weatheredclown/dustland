# TypeScript `@ts-nocheck` Removal Roadmap

This roadmap tracked the removal of `@ts-nocheck` from the TypeScript sources. All suppressions are now gone; the sections below are retained as historical notes and guardrails to keep future changes aligned with the typed helpers that closed the project.

## Current status snapshot

- **Last updated**: 2025-12-01 by automated agent.
- **Files remaining with `@ts-nocheck`**: 0. The count is generated by `rg "@ts-nocheck" ts-src -l | wc -l` and will serve as a guardrail to catch regressions.
- **Guardrail test**: `test/ts-nocheck.guard.test.js` fails if any TypeScript source reintroduces the suppression header.
- **Shared helpers already typed**: combat queue utilities, dialog registries, module schemas, multiplayer/session helpers, and the workbench loader. Treat these files as reference implementations when introducing new ambient definitions.
- **Primary risks**: with suppressions removed, the main risk is drift—new code that bypasses the shared helpers or reintroduces ambient `any` usage. Keep the lint rules and shared types in sync with runtime behavior.

## 1. Core engine infrastructure (complete)

**Scope**: `ts-src/scripts/dustland-core.ts`, the `core/` directory (combat, dialog, effects, inventory, item-generator, module-behaviors, movement, npc, quests, trader), and orchestration files such as `dustland-engine.ts`, `dustland-nano.ts`, `procedural-map.ts`, `multiplayer.ts`, and `adventure-kit.ts`.

**Notes**
- These files share hundreds of globals that are currently declared implicitly. Capturing the common surface in ambient definitions will unblock multiple files at once.
- Several modules (combat, inventory, movement) mutate shared state; typed helpers that wrap `globalThis` access will keep the implementation similar to the pattern established in `workbench.ts`.

**Exit criteria**
- `ts-src/global.d.ts` exposes typed surfaces for the player model, NPC collections, inventory, quests, and the event bus.
- All files in `ts-src/scripts/core/` compile without `@ts-nocheck` and use shared helpers instead of raw `globalThis` access.
- `dustland-core.ts`, `dustland-engine.ts`, `procedural-map.ts`, and `multiplayer.ts` pass type-checking without suppressions.

**Status**
- Achieved; the remaining work now focuses exclusively on the Adventure Kit and its UI helpers.

**Suggested steps**
1. Extend `ts-src/global.d.ts` with structured interfaces for `player`, `NPCS`, `EventBus`, combat entities, and quest data so downstream code can reuse them. Track progress in a checklist that pairs each interface with the file that first consumes it.
2. Convert one subsystem at a time (for example `core/party.ts` → `core/movement.ts` → `dustland-core.ts`), replacing bare global reads with typed accessors. Start with files that already expose TypeScript types (party, inventory) to bootstrap the shared definitions.
3. Introduce lightweight utility modules (e.g., `ts-src/types/globals.ts`) if repeated casting becomes noisy. Favor pure functions that accept ambient state as parameters to simplify testing.
4. After each batch, run `npm test` and `npm run build` to ensure the interaction-heavy suites stay green before moving to the next subsystem.
5. Once the shared definitions stabilize, enable `strictNullChecks` in a throwaway branch to gauge remaining hotspots. Document any blockers in this roadmap before attempting to flip the flag globally.

## 2. Module data bundles (complete)

**Scope**: `ts-src/modules/*.module.ts`.

**Notes**
- These files export large literal objects. Most errors stem from implicit `any` usage and reliance on `globalThis` helpers (`findItemIndex`, `removeFromInv`, `addToInv`).
- Creating module-specific type aliases (for encounters, NPC definitions, loot tables) will make the literals self-documenting.

**Exit criteria**
- `ts-src/modules/types.ts` (or its successor) captures the shared schema for rooms, encounters, NPCs, dialog trees, loot tables, and triggers.
- Each module exports a typed object that satisfies the schema without resorting to `as any` casts.
- Global inventory helpers are invoked through typed wrappers or dependency injection, eliminating ambient lookups in module definitions.

**Status**
- Achieved; module schemas now provide reference shapes for the Adventure Kit export flows.

**Suggested steps**
1. Add shared module schema types to `ts-src/modules/types.ts` (or extend the existing schema definitions) that describe rooms, NPCs, encounters, and dialog trees. Include a validation harness (simple Zod-like shape or JSON schema) to spot regressions as modules are refactored.
2. Replace the global helper lookups with the typed utilities introduced in the engine work, or inject them via function parameters when possible.
3. Remove `@ts-nocheck` one module at a time, starting with the smallest (e.g., `edge.module.ts`) to validate the schema before tackling larger story modules. Capture lessons learned in module-specific READMEs to accelerate the later conversions.
4. Coordinate module conversions with narrative designers so they can validate that loot tables and dialog variants still match the design intent.

## 3. UI and tooling scripts

**Scope**: `ts-src/scripts/ui/skin-manager.ts`, `ts-src/scripts/workbench.ts` (already typed), `ts-src/music-demo.ts`, `ts-src/scripts/dustland-nano.ts`, and `ts-src/scripts/adventure-kit.ts`.

**Notes**
- These scripts interact with the DOM and browser APIs. Typing them mostly involves annotating the DOM elements and defining ambient types for third-party libraries (Tone.js, Magenta, Nano dialog helpers).
- `music-demo.ts` is self-contained but large; treat it as a separate effort once the engine globals are in place.

**Exit criteria**
- All UI scripts compile without `@ts-nocheck`, rely on typed DOM helpers, and include inline documentation for tricky browser API interactions.
- External libraries (Tone.js, Magenta) are covered by ambient type declarations or vendored `.d.ts` files.
- Reusable UI state containers (theme settings, nano dialog state) expose explicit interfaces consumed by multiple files.

**Status**
- Achieved; UI entry points, Nano helpers, and the Adventure Kit all compile cleanly with typed DOM utilities.

**Suggested steps**
1. Define DOM-centric utility types (e.g., `Nullable<T> = T | null`) and ambient declarations for external libraries in `global.d.ts` or dedicated `d.ts` files. Capture them in `tsconfig.json`'s `types` array so editors pick them up automatically.
2. Convert `skin-manager.ts` next—it primarily manipulates style properties and should compile once the CSS variable map is typed. Ensure all CSS custom properties referenced in TypeScript have corresponding entries in `dustland.css` to avoid runtime mismatches.
3. Address `dustland-nano.ts` and `adventure-kit.ts` after the engine globals are formalized, since they depend on the same shared APIs. Write lightweight integration tests that mount the primary UI flows in jsdom to catch regressions while typing.
4. Reserve `music-demo.ts` for last; split it into smaller helpers if needed to stay within manageable review size. Document any Tone.js abstractions so newcomers can trace signal flow quickly.

## 4. Adventure Kit `@ts-nocheck` removal (complete)

**Scope**: `ts-src/scripts/adventure-kit.ts` and its dependencies in `ts-src/scripts/core/`, `ts-src/modules/`, and the UI helper files that power the module builder HTML.

**Why it is tricky**
- The file mixes DOM access, canvas drawing, and game data mutations through `globalThis`. Most globals originate from `dustland-core.ts`, `scripts/core/` helpers, or module schemas.
- UI state (drag targets, hover tiles, NPC editing forms) flows through loosely typed module data. Aligning those structures with the engine’s typed globals is a prerequisite.

**Exit criteria**
- `adventure-kit.ts` compiles without `@ts-nocheck` while relying on shared ambient types instead of inline `any` casts.
- Canvas interactions, tile metadata, and NPC/loot editors use typed helpers for DOM querying and module mutation.
- Adventure Kit smoke tests cover map stamping, NPC placement, loot editing, and export flows to guard regressions while typing.

**Work breakdown**
1. **Catalog dependencies**: List every `globalThis` read/write in `adventure-kit.ts` (world grids, moduleData, NPC collections, placement helpers) and map each to an existing or planned ambient type in `ts-src/global.d.ts` or `scripts/core/globals.ts`. Fill gaps with new interfaces (e.g., `AdventureKitState`, `EditableModuleData`).
2. **Type the DOM surface**: Introduce typed query helpers for the canvas, toolbars, form fields, and notice elements. Reuse the query patterns from `workbench.ts` to avoid null assertions and to centralize `HTMLElement` narrowing.
3. **Model map data and tools**: Create types for tile palettes, stamps, brush modes, placement callbacks, and heat-map overlays. Wire these through the existing rendering helpers (`gridFromEmoji`, `focusMap`, `getTileAt`) so canvas operations stay type-safe.
4. **Constrain NPC and loot editors**: Define interfaces for NPC snapshots, spawn points, dialog IDs, loot tables, and playtest flags (`PLAYTEST_KEY`). Replace implicit object shapes with these interfaces and ensure mutations flow through typed utility functions rather than ad-hoc property writes.
5. **Harden events and persistence**: Type the event hooks that respond to mouse interactions, keyboard shortcuts, and module export/download flows. Add a lightweight jsdom test suite that simulates drag/drop placement and verifies exported module JSON matches the typed schema.
6. **Remove the suppression**: Once the shared globals and DOM helpers land, delete `@ts-nocheck`, run `npm test`, and validate `npm run build` to ensure Adventure Kit still boots from `adventure-kit.html` when opened from disk. *(Complete.)*

## Reporting cadence

- Update this roadmap after each merge that removes a `@ts-nocheck` header. Include the interface or helper introduced so future contributors can reuse it.
- Keep a running table (in this document or an adjacent `progress.md`) that maps file names to owners and planned sprint windows. This makes it easy to see which areas are blocked or ready for review.
- Celebrate intermediate wins—post a short note in the engineering channel when a subsystem is fully typed to reinforce the momentum.

This roadmap is now closed. Before merging new UI or engine work, rerun `rg "@ts-nocheck" ts-src -l | wc -l` to ensure suppressions stay at zero; reopen the document only if that check regresses.

### Recent progress log

| Date       | Summary |
| ---------- | ------- |
| 2025-12-01 | Removed the final `@ts-nocheck` header from `ts-src/scripts/adventure-kit.ts`, confirmed the suppression count is zero, and retired this roadmap. |
| 2025-11-29 | Recounted `@ts-nocheck` headers; Adventure Kit is the only remaining suppression. Updated the status snapshot and marked prior phases complete. |
| 2025-11-19 | Recounted `@ts-nocheck` headers; five files remain (combat, movement, dustland-core, dustland-engine, adventure-kit) after prior conversions. Updated the status snapshot for downstream planning. |
| 2025-11-19 | Removed `@ts-nocheck` from `ts-src/scripts/module-picker.ts` by introducing a typed `DustlandWindow` helper and narrowing the multiplayer/event bus globals. Updated the suppression count to 6 remaining files. |
| 2025-11-14 | Removed `@ts-nocheck` from `ts-src/scripts/multiplayer.ts` by introducing multiplayer session types and guarding Dustland globals. Refreshed the suppression count to 11 remaining files. |
| 2025-10-30 | Removed `@ts-nocheck` from `ts-src/scripts/dustland-nano.ts` by introducing typed Nano dialog and palette state along with guarded global lookups. Refreshed the suppression count to 14 remaining files. |
| 2025-10-30 | Removed `@ts-nocheck` from `ts-src/modules/edge.module.ts` by introducing an `EdgeModule` type alias and wiring the loader through typed globals. Refreshed the suppression count to 18 remaining files. |
| 2025-10-29 | Introduced `scripts/core/globals.ts` to expose typed helpers (DustlandGlobals) and removed `@ts-nocheck` from `ts-src/scripts/core/item-generator.ts`. Updated UI entry points and tests to load the helper before exercising ItemGen. |
| 2025-10-28 | Removed `@ts-nocheck` from `ts-src/scripts/core/trader.ts` by introducing typed trader inventory helpers and stricter price calculations. Updated the global snapshot to reflect 21 files remaining. |
| 2024-05-12 | Recounted the remaining suppressions (24 total) and categorized them by subsystem so future work can be pulled in smaller batches. Added this progress log section to track future milestones inline. |

Following this sequence keeps each phase focused and maximizes reuse of newly introduced type definitions. The approach mirrors the conversions in `workbench.ts` and `dustland-path.ts`, so future migrations can lean on those patterns.
