# ComfyUI workflow for Dustland skin styles

This guide walks through Dustland's skin pipeline and explains how to generate
complete UI skin drops in multiple art directions with ComfyUI.

## How the skin system works

Dustland's runtime skin manager exposes every UI region through CSS variables,
slot-level overrides, and sprite lookups. When a skin is applied it writes the
variables listed in `UI_VAR_MAP`, applies per-slot styles declared under
`skin.ui.slots`, and preloads tile, item, and icon atlases so gameplay renders
use the new art set immediately.【F:scripts/ui/skin-manager.js†L5-L343】【F:scripts/ui/skin-manager.js†L360-L463】

To ship a full reskin you provide:

- Texture and sprite assets that match the sizes in the [UI skin asset
  specification](../../../docs/design/ui-skin-asset-spec.md). Save each render as
  `<slot-name>.png` inside a folder named after the skin ID (for example
  `emerald-grid/panel_background.png`). The runtime automatically resolves tile,
  UI, and HUD art from that layout.【F:scripts/ui/skin-manager.js†L240-L463】
- Optional overrides for CSS variables or atlas metadata when you need more than
  the default `<slot>.png` lookup. You can register those overrides with
  `Dustland.skin.registerSkin()` the same way handcrafted skins do.【F:scripts/ui/skin-manager.js†L1124-L1196】

## Skin style workflow overview

The `SkinStyleJSONLoader` custom node reads a template describing the required
UI assets and expands it into concrete prompts for every style variant you want
to render. Its output plugs directly into the existing `Dustland Game Asset
Batch Renderer`, so you can reuse the same sampling path that already saves
textures to disk.【F:comfyui/custom_nodes/dustland_skin_batch/__init__.py†L1-L254】【F:comfyui/custom_nodes/dustland_game_assets/__init__.py†L1-L224】

The repository includes:

| File | Purpose |
| --- | --- |
| `comfyui/custom_nodes/dustland_skin_batch/` | Custom node that expands a skin template into per-style prompts. |
| `comfyui/examples/skin_style_plan.json` | Sample template covering the core UI assets with two style variants. |
| `comfyui/examples/comfyui-skin-style-workflow.json` | Importable ComfyUI workflow wiring the loader, renderer, and preview. |

## Template structure

Open [`comfyui/examples/skin_style_plan.json`](../../examples/skin_style_plan.json) to
see how the template works.【F:comfyui/examples/skin_style_plan.json†L1-L80】 The key
sections are:

- `base_prompt`, `lighting_prompt`, `palette_prompt`: global prompt segments
  applied to every asset.
- `styles`: list of style variants. Each variant supplies its own `id`, prompt
  additions, palette notes, and optional negative prompt to suppress unwanted
  colors.【F:comfyui/examples/skin_style_plan.json†L10-L23】
- `assets`: array describing each UI texture. Use `slot` to name the asset,
  `filename` to control the saved file prefix, and `width`/`height` to set the
  render resolution.【F:comfyui/examples/skin_style_plan.json†L24-L78】 Placeholders
  such as `{style_id}` or `{slot_title}` are replaced per style using the
  context generated by the loader.【F:comfyui/custom_nodes/dustland_skin_batch/__init__.py†L101-L188】

You can override the styles listed in the JSON by entering lines in the loader's
`styles_override` widget (`style_id | prompt | negative`). The overrides are
parsed first and take precedence over the `styles` array, which makes it easy to
quickly audition new looks without editing files.【F:comfyui/custom_nodes/dustland_skin_batch/__init__.py†L59-L96】

## Running the ComfyUI workflow

1. Copy the custom node directories into ComfyUI:
   - `comfyui/custom_nodes/dustland_game_assets/`
   - `comfyui/custom_nodes/dustland_skin_batch/`
   Place them under `ComfyUI/custom_nodes/`, then restart ComfyUI so it
   registers the new nodes.
2. Import `comfyui/examples/comfyui-skin-style-workflow.json` through the ComfyUI
   sidebar (`Load` → `Workflow`).【F:comfyui/examples/comfyui-skin-style-workflow.json†L1-L81】
3. Copy `comfyui/examples/skin_style_plan.json` into ComfyUI's `input/` directory.
   Update the loader's `json_source` widget if you rename or relocate the file.
4. (Optional) Enter new variants in `styles_override` to render additional
   palettes in the same batch.【F:comfyui/custom_nodes/dustland_skin_batch/__init__.py†L59-L96】
5. Select your preferred checkpoint on the `Checkpoint Loader` node.
6. Queue the workflow. The batch renderer iterates every asset/style combination
   and saves the textures using the slugified filename from the template.
   Preview images show the first few renders, while the `Note` node displays the
    summary emitted by the loader.【F:comfyui/custom_nodes/dustland_skin_batch/__init__.py†L187-L253】【F:comfyui/examples/comfyui-skin-style-workflow.json†L48-L118】

Generated files land in ComfyUI's `output/` directory inside per-style folders
(`output/emerald-grid/`, `output/sunset-vapor/`, etc.). Each folder now contains
only the rendered PNGs; no manifest is required. Drop the folder into
`ComfyUI/output/` inside the Dustland repo and preview it with the **Load Skin**
control or by calling:

```js
Dustland.skin.loadGeneratedSkin('emerald-grid', {
  baseDir: 'ComfyUI/output',
  styleDir: 'emerald-grid'
});
```

The CLI prints the helper call for every style so you can copy-paste it while
ComfyUI is still running.

## Troubleshooting missing nodes

  - ComfyUI must be restarted after copying new Python files into `custom_nodes/`;
    the loader only scans for node definitions during startup. If the workflow
    still reports `SkinStyleJSONLoader` as missing, quit and relaunch the app so
    it imports `dustland_skin_batch` again.【F:comfyui/custom_nodes/dustland_skin_batch/__init__.py†L1-L254】
  - Verify both the `dustland_skin_batch` and `dustland_game_assets`
    directories were copied into `ComfyUI/custom_nodes/`. Each `__init__.py` file
    declares the `NODE_CLASS_MAPPINGS` needed for ComfyUI to register the nodes
    referenced in the example workflow.【F:comfyui/custom_nodes/dustland_game_assets/__init__.py†L1-L224】
- Check ComfyUI's console output during startup; successful registration prints
  entries such as `Loaded Dustland Skin Style JSON Loader`. If no Dustland nodes
  appear in the log, confirm the folder path and file permissions.


## Integrating with Dustland

After rendering, wire the images into a `DustlandSkin` definition. Populate:

- `skin.ui.vars` for global CSS variables (backgrounds, borders, shadows).
- `skin.ui.slots` for targeted overrides on elements tagged with
  `data-skin-slot` attributes.
- `skin.tiles`, `skin.icons`, and related sections for atlases and sprites used
  in the map, inventory, and HUD.【F:scripts/ui/skin-manager.js†L200-L463】

Keep the [asset size spec](../../../docs/design/ui-skin-asset-spec.md) handy while mapping
textures so the in-game stretching and nine-slice padding look correct.
