<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adventure Construction Kit</title>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dustland.css" />
  <script>
    (function loadHostedFirebaseBootstrap() {
      const moduleUrl = './scripts/hosting/firebase-bootstrap.js';
      let dynamicImportsBroken = false;
      const handleError = (error) => {
        if (error?.code === 'ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING') {
          dynamicImportsBroken = true;
          return;
        }
        console.warn('Skipping hosted Firebase bootstrap.', error);
      };
      try {
        if (dynamicImportsBroken) return;
        import(moduleUrl)
          .then((module) => {
            if (typeof module.bootstrapHostedFirebase === 'function') {
              module.bootstrapHostedFirebase(window);
            }
          })
          .catch(handleError);
      } catch (error) {
        handleError(error);
      }
    })();
  </script>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #c8f7c9;
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 0.875rem;
      line-height: 1.5;
      position: relative;
      min-height: 100vh;
    }

    body:after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(to bottom, rgba(255, 255, 255, .05)0, rgba(255, 255, 255, .05)1px, rgba(0, 0, 0, 0)2px);
      mix-blend-mode: overlay;
      opacity: .15;
    }

    canvas {
      border: 1px solid #2b3b2b;
      background: #000;
      image-rendering: pixelated;
      box-shadow: 0 0 12px #000, 0 0 8px #9ef7a0;
    }

    .card {
      padding: 8px;
      background: #0f120f;
      border: 2px solid #2b3b2b;
      border-radius: 8px;
      box-shadow: 0 0 12px #000, 0 0 8px #9ef7a0;
    }

    .list {
      font-size: 0.8125rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .list div {
      cursor: pointer;
    }

    .list-item-btn {
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: inherit;
      font: inherit;
      cursor: pointer;
      padding: 2px 0;
    }

    .list-item-btn:hover,
    .list-item-btn:focus {
      background: rgba(158, 247, 160, 0.1);
      outline: none;
    }

    .list-item-btn:focus-visible {
      outline: 2px solid #78c078;
      outline-offset: -2px;
    }

    .lootTableWrap {
      margin-top: 4px;
    }

    .lootTableLabel {
      font-size: 0.75rem;
      opacity: 0.75;
      margin-top: 4px;
    }

    .lootTableHeader {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 2px;
    }

    .lootTable {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .lootRow {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .lootRow select {
      flex: 1;
    }

    .lootRow input {
      width: 72px;
    }

    .lootRow .btn {
      margin-top: 0;
    }

    .arenaWave {
      border: 1px solid #2b3b2b;
      border-radius: 6px;
      background: #0c100c;
      padding: 6px;
      margin-top: 6px;
    }

    .arenaWaveHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      text-transform: uppercase;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .arenaWaveRemove {
      font-size: 0.75rem;
      padding: 2px 6px;
    }

    .arenaWave details {
      margin-top: 6px;
      border-top: 1px solid #2b3b2b;
      padding-top: 4px;
    }

    #problemCard {
      border-color: #a00;
    }
    #problemCard .list div {
      color: #f66;
    }

    label {
      display: block;
      margin-top: 4px;
      font-size: 0.75rem;
    }

    input,
    textarea,
    select {
      width: 100%;
      margin-top: 2px;
      background: #101910;
      border: 1px solid #2b3b2b;
      color: #c8f7c9;
      font-family: inherit;
      font-size: 0.8125rem;
      border-radius: 4px;
    }

    input[type=checkbox] {
      appearance: none;
      width: 14px;
      height: 14px;
      margin-top: 0;
      display: inline-block;
      border: 1px solid #9ef7a0;
      border-radius: 2px;
      background: #1a2f1a;
      position: relative;
    }

    input[type=checkbox]:checked::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 4px;
      width: 3px;
      height: 7px;
      border: solid #9ef7a0;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .xy {
      display: flex;
      gap: 4px;
    }
    .xy label {
      display: flex;
      flex-direction: column;
    }
    .xy input {
      width: 60px;
    }

    button.btn {
      margin-top: 6px;
      font-size: 0.875rem;
    }

    .btn-group .btn {
      font-size: 0.8125rem;
    }

    #stampWindow {
      position: absolute;
      background: #0f120f;
      border: 1px solid #2b3b2b;
      padding: 4px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 50;
    }

    #stampWindow .stamp-option {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      margin-bottom: 4px;
    }

    #stampWindow canvas {
      image-rendering: pixelated;
      border: 1px solid #2b3b2b;
    }

    #stampWindow #nanoStampBtn {
      font-size: 0.75rem;
      margin: 4px auto 0;
      display: block;
      padding: 2px 4px;
    }

    legend {
      font-size: 1rem;
      font-weight: 600;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      border: 1px solid #2b3b2b;
      padding: 4px;
      margin-top: 8px;
    }

    #treeEditor .node {
      border: 1px solid #2b3b2b;
      padding: 4px;
      margin-top: 4px;
    }

    #treeEditor .choices div {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    #treeEditor .choices input,
    #treeEditor .choices select {
      flex: 1 1 120px;
      width: auto;
      min-width: 120px;
    }

    #treeEditor .choices .choiceSuccess,
    #treeEditor .choices .choiceFailure {
      flex-basis: 100%;
    }

    #treeEditor .choices label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 0;
      flex: 0 0 auto;
    }

    #treeEditor .choices .delChoice {
      flex: 0 0 auto;
    }

    #treeEditor .choiceGroup {
      border: 1px solid #2b3b2b;
      padding: 4px;
      margin-top: 4px;
    }

    #treeEditor .choiceGroup legend {
      padding: 0 4px;
    }

    #treeEditor .choiceAdv fieldset {
      border: 1px solid #2b3b2b;
      padding: 4px;
      margin-top: 4px;
    }

    #treeEditor .choiceAdv fieldset legend {
      padding: 0 4px;
    }

    #treeEditor .choices details {
      flex-basis: 100%;
    }

    #treeEditor .choices details summary {
      cursor: pointer;
    }

    #treeEditor .choices details[open] {
      border: 1px solid #2b3b2b;
      padding: 4px;
    }

    #treeEditor .choices details label {
      display: block;
      margin-top: 4px;
    }

    #treeEditor .choices details label:first-child {
      margin-top: 0;
    }

    #treeEditor .choices label.inline,
    #treeEditor .choices label.onceWrap {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #treeEditor .choices details input,
    #treeEditor .choices details select {
      width: 100%;
      flex: none;
      min-width: 0;
    }

    #treeEditor .choices details input[type=checkbox] {
      width: 14px;
      height: 14px;
    }

    #treeEditor .nodeHeader {
      display: flex;
      align-items: center;
    }

    #treeEditor .nodeHeader .btn {
      padding: 2px 4px;
      margin: 0 4px 0 0;
    }

    #treeEditor .toggle {
      margin-right: 4px;
    }

    #treeEditor .delNode {
      margin-left: auto;
      margin-right: 0;
    }

    #treeEditor .node.collapsed .nodeBody {
      display: none;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .6);
      z-index: 100;
    }

    .modal.shown {
      display: flex;
    }

    #dialogModal .card {
      position: relative;
      width: 600px;
      max-height: 80vh;
      overflow: auto;
    }

    #loadModal .card {
      width: 420px;
      max-width: calc(100% - 20px);
    }

    #loadDropZone {
      border: 1px dashed #6fc58f;
      padding: 12px;
      text-align: center;
      border-radius: 6px;
      background: rgba(0, 0, 0, .25);
      cursor: pointer;
    }

    #loadDropZone.dragging {
      border-color: #fff;
      background: rgba(110, 197, 143, .15);
    }

    #loadModalActions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
    }
  </style>
</head>

<body class="adventure-kit">
  <canvas id="game" width="0" height="0" class="glow" aria-label="Dustland CRT"></canvas>
  <div class="ak-layout">
      <section class="card map-card" id="mapCard">
        <canvas id="map" width="640" height="480" aria-label="Map preview"></canvas>
        <div id="mapActionBanner" class="inline-hint" role="status" aria-live="polite" style="display:none"></div>
        <label>Map<select id="mapSelect"></select></label>
        <div class="btn-group" id="paletteGroup">
          <div id="paletteWrap">
            <div id="nanoStatus">
              <div id="nanoProgress" class="nano-progress"></div>
              <div id="nanoBadge" class="nano-badge off">‚úó</div>
            </div>
            <div id="worldPalette">
              <button type="button" data-tile="0" style="background:#1e271d" title="Sand"></button>
              <button type="button" data-tile="1" style="background:#2c342c" title="Rock"></button>
              <button type="button" data-tile="2" style="background:#1573ff" title="Water"></button>
              <button type="button" data-tile="3" style="background:#203320" title="Brush"></button>
              <button type="button" data-tile="4" style="background:#777777" title="Road"></button>
              <button type="button" data-tile="5" style="background:#304326" title="Ruin"></button>
              <button type="button" data-tile="6" style="background:#4d5f4d" title="Wall"></button>
            </div>
            <button class="btn" type="button" id="stampsBtn" title="Stamps" aria-label="Stamps">üîñ</button>
            <div id="stampWindow"></div>
            <div id="paletteLabel"></div>
          </div>
          <button class="btn" id="noiseToggle" title="Toggle organic brush noise">Noise: On</button>
          <label for="brushSize">Brush Size <input type="range" id="brushSize" min="1" max="10" value="1"><span id="brushSizeLabel">1</span></label>
        </div>
        <div class="btn-group">
          <div style="padding:0px 13px 0px 0px;font-family: sans-serif;">
          <label for="moduleName">Module Name</label>
          <input type="text" id="moduleName" />
          </div>
          <div style="padding:0px 13px 0px 0px;font-family: sans-serif;max-width:200px;">
          <label for="moduleBunkerScope">Bunker Travel</label>
          <select id="moduleBunkerScope">
            <option value="global">Share across modules</option>
            <option value="module">This module only</option>
          </select>
          </div>
          <button class="btn btn--primary" id="save" title="Download module as a JSON file">Save</button>
          <button class="btn" id="load" title="Load a module from a JSON file">Load</button>
        </div>
        <div class="btn-group">
          <button class="btn" id="setStart" title="Set player starting tile">Set Start</button>
          <button class="btn" id="resetStart" title="Reset player starting tile to the default">Reset Start</button>
          <button class="btn" id="clear" title="Clear the entire map">Clear Map</button>
        </div>
        <div class="btn-group">
          <label for="procSeed">Seed <input type="number" id="procSeed" style="width:80px" /></label>
          <label for="procFalloff">Falloff <input type="range" id="procFalloff" min="0" max="1" step="0.1" value="0" /></label>
          <label><input type="checkbox" id="procRoads" checked /> Roads</label>
          <label><input type="checkbox" id="procRuins" checked /> Ruins</label>
          <button class="btn" id="procGen" title="Generate a procedural map">Generate</button>
          <button class="btn" id="procRegen" title="Regenerate using last settings">Regenerate</button>
        </div>
        <div class="btn-group">
          <button class="btn" id="spawnHeatBtn" title="Toggle spawn heat map">Spawn Heat: Off</button>
        </div>
    </section>
    <aside class="editor-panel" id="editorPanel" aria-hidden="false">
      <fieldset class="card" id="problemCard" style="display:none;border-color:#a00">
        <legend>Problems</legend>
        <div class="list" id="problemList"></div>
      </fieldset>
      <div class="tabs2" role="tablist" aria-label="Editors">
        <button class="tab2 active" type="button" data-tab="npc" role="tab" aria-selected="true"><span aria-hidden="true">üßç</span> NPCs</button>
        <button class="tab2" type="button" data-tab="items" role="tab" aria-selected="false"><span aria-hidden="true">üéí</span> Items</button>
        <button class="tab2" type="button" data-tab="buildings" role="tab" aria-selected="false"><span aria-hidden="true">üè†</span> Buildings</button>
        <button class="tab2" type="button" data-tab="interiors" role="tab" aria-selected="false"><span aria-hidden="true">üõã</span> Interiors</button>
        <button class="tab2" type="button" data-tab="portals" role="tab" aria-selected="false"><span aria-hidden="true">üåÄ</span> Portals</button>
        <button class="tab2" type="button" data-tab="quests" role="tab" aria-selected="false"><span aria-hidden="true">üìú</span> Quests</button>
        <button class="tab2" type="button" data-tab="events" role="tab" aria-selected="false"><span aria-hidden="true">‚ú®</span> Events</button>
        <button class="tab2" type="button" data-tab="arenas" role="tab" aria-selected="false"><span aria-hidden="true">‚öîÔ∏è</span> Arenas</button>
        <button class="tab2" type="button" data-tab="zones" role="tab" aria-selected="false"><span aria-hidden="true">üó∫</span> Zones</button>
        <button class="tab2" type="button" data-tab="encounters" role="tab" aria-selected="false"><span aria-hidden="true">üé≤</span> Encounters</button>
        <button class="tab2" type="button" data-tab="templates" role="tab" aria-selected="false"><span aria-hidden="true">üì¶</span> Templates</button>
        <button class="tab2" type="button" data-tab="wizards" role="tab" aria-selected="false"><span aria-hidden="true">üßô</span> Wizards</button>
      </div>
      <div class="tabpanes">
        <fieldset class="card" id="npcCard" data-pane="npc">
          <legend>NPCs</legend>
          <input id="npcFilter" placeholder="Filter NPCs..." />
          <div class="list" id="npcList"></div>
          <button class="btn" type="button" id="newNPC">New NPC</button>
          <div id="npcEditor" style="display:none">
            <div id="npcFormNotice" class="inline-hint" role="status" aria-live="polite"></div>
            <label>ID<input id="npcId" placeholder="npc_id" /></label>
          <label>Name<input id="npcName" placeholder="NPC name" /></label>
          <label>Title<input id="npcTitle" placeholder="NPC title" /></label>
          <label>Description<textarea id="npcDesc" rows="2"></textarea></label>
          <label><input type="checkbox" id="npcColorOverride"> Override Color</label>
          <label id="npcColorWrap" style="display:none">Color<input id="npcColor" type="color" value="#9ef7a0" /></label>
          <label>Symbol<input id="npcSymbol" maxlength="1" value="!" /></label>
          <label>Map<select id="npcMap"></select></label>
          <div class="xy">
            <label>X<input id="npcX" type="number" min="0" /></label>
            <label>Y<input id="npcY" type="number" min="0" /></label>
          </div>
          <label><input type="checkbox" id="npcPatrol"> Patrol NPC</label>
          <div id="npcLoopPts" style="display:none"></div>
          <button class="btn" type="button" id="addLoopPt" style="display:none">+ Waypoint</button>
          <div class="portrait" id="npcPort"></div>
          <div class="row" style="margin:8px 0">
            <button type="button" class="pill" id="npcPrevP" aria-label="Previous portrait">&lt;</button>
            <span class="pill">Portrait</span>
            <button type="button" class="pill" id="npcNextP" aria-label="Next portrait">&gt;</button>
          </div>
          <label><input type="checkbox" id="npcPortraitLock" checked> Lock Portrait</label>
          <label>Tile Sprite<input id="npcTileSprite" placeholder="custom asset id" /></label>
          <div class="row" style="align-items:center;gap:8px;margin:4px 0">
            <div id="npcTileSpritePreview" class="small muted" style="min-width:36px;min-height:36px;display:flex;align-items:center;justify-content:center;border:1px dashed #444;padding:2px;"></div>
            <input type="file" id="npcTileSpriteUpload" accept="image/png,image/webp" style="display:none" />
            <button class="btn" type="button" id="npcTileSpriteUploadBtn">Upload Sprite</button>
          </div>
          <label><input type="checkbox" id="npcHidden"> Hidden NPC</label>
          <label><input type="checkbox" id="npcLocked"> Locked NPC</label>
          <label><input type="checkbox" id="npcInanimate"> Inanimate</label>
          <div id="revealOpts" style="display:none">
            <label>Flag Type<select id="npcFlagType"><option value="visits">Visited Tile</option><option value="party">Party Flag</option></select></label>
            <div id="revealVisit">
              <label>Map<select id="npcFlagMap"></select></label>
              <div class="xy">
                <label>X<input id="npcFlagX" type="number" min="0" /></label>
                <label>Y<input id="npcFlagY" type="number" min="0" /></label>
              </div>
              <button class="btn" type="button" id="npcFlagPick" title="Click on the map to select a tile">Pick Tile</button>
            </div>
            <div id="revealParty" style="display:none">
              <label>Name<input id="npcFlagName" list="npcFlagList" /></label>
              <datalist id="npcFlagList"></datalist>
            </div>
            <label>Op<select id="npcOp"><option value=">=">&ge;</option><option value=">">&gt;</option><option value="==">==</option><option value="!=">!=</option><option value="<=">&le;</option><option value="<">&lt;</option></select></label>
            <label>Value<input id="npcVal" type="number" value="1" /></label>
          </div>
          <div class="row" style="gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap">
            <button class="btn" type="button" id="npcPick" title="Click on the map to choose location">Select on Map</button>
            <button class="btn" type="button" id="npcCancelPick" style="display:none">Cancel Placement</button>
          </div>
          <label>Dialog<textarea id="npcDialog" rows="2"></textarea></label>
          <div id="npcDialogHint" class="small" style="display:none">Dialog text is set in the dialog tree.</div>
          <label>Quests<select id="npcQuests" multiple size="3"></select></label>
          <button class="btn" type="button" id="genQuestDialog" style="display:none">Generate Quest Dialog</button>
          <div id="questTextWrap" style="display:none">
            <label>Accept Text<textarea id="npcAccept" rows="2">Good luck.</textarea></label>
            <label>Turn-in Text<textarea id="npcTurnin" rows="2">Thanks for helping.</textarea></label>
          </div>
          <label><input type="checkbox" id="npcCombat"> Combat NPC</label>
          <div id="combatOpts" style="display:none">
            <label>HP<input id="npcHP" type="number" min="1" value="5" /></label>
            <label>ATK<input id="npcATK" type="number" min="0" value="0" /></label>
            <label>DEF<input id="npcDEF" type="number" min="0" value="0" /></label>
            <label>Loot<input id="npcLoot" /></label>
            <label>Loot %<input id="npcLootChance" type="number" min="0" max="100" value="" /></label>
            <label><input type="checkbox" id="npcBoss" /> Boss</label>
            <label>Special Cue<input id="npcSpecialCue" /></label>
            <label>Special DMG<input id="npcSpecialDmg" type="number" min="0" /></label>
            <label>Special Delay<input id="npcSpecialDelay" type="number" min="0" /></label>
          </div>
          <label><input type="checkbox" id="npcShop"> Shop NPC</label>
          <div id="shopOpts" style="display:none">
            <label>Markup<input id="shopMarkup" type="number" min="1" value="2" /></label>
            <label>Refresh<input id="shopRefresh" type="number" min="0" value="0" /></label>
          </div>
          <label><input type="checkbox" id="npcTrainer"> Trainer NPC</label>
          <div id="trainerOpts" style="display:none">
            <label>Trainer Type<select id="npcTrainerType"><option value="power">Power</option><option value="endurance">Endurance</option><option value="tricks">Tricks</option></select></label>
          </div>
          <label><input type="checkbox" id="npcWorkbench"> Workbench NPC</label>
          <div id="treeWrap">
            <label>Dialog Tree</label>
            <button class="btn" type="button" id="editDialog">Edit Dialog</button>
          </div>
          <textarea id="npcTree" style="display:none"></textarea>
          <div id="dialogPreview" style="margin-top:6px"></div>
            <div class="editor-actions">
              <div id="npcMapBanner" class="inline-hint" style="display:none"></div>
              <button class="btn btn--primary" id="saveNPC" disabled>Save NPC</button>
              <button class="btn" type="button" id="discardNPC">Discard</button>
              <button class="btn" id="delNPC" style="display:none">Delete NPC</button>
              <button class="btn" type="button" id="closeNPC">Done</button>
            </div>
          </div>
        </fieldset>
      <fieldset class="card" id="itemCard" data-pane="items" style="display:none">
        <legend>Items</legend>
        <input id="itemFilter" placeholder="Filter items..." />
        <div class="list" id="itemList"></div>
        <button class="btn" type="button" id="newItem">+ Item</button>
        <div id="itemEditor" style="display:none">
          <label>Name<input id="itemName" placeholder="Item name" /></label>
          <label>ID<input id="itemId" placeholder="item_id" /></label>
          <label>Type<select id="itemType">
              <option value=""></option>
              <option value="weapon">Weapon</option>
              <option value="armor">Armor</option>
              <option value="trinket">Trinket</option>
              <option value="consumable">Consumable</option>
              <option value="quest">Quest</option>
              <option value="misc">Misc</option>
            </select></label>
          <label>Description<textarea id="itemDesc" rows="2"></textarea></label>
          <label>Tags<input id="itemTags" list="tagOptions" /></label>
          <datalist id="tagOptions"></datalist>
          <label>Narrative ID<input id="itemNarrativeId" /></label>
          <label>Narrative Prompt<input id="itemNarrativePrompt" /></label>
          <label>Tile Sprite<input id="itemTileSprite" placeholder="custom asset id" /></label>
          <div class="row" style="align-items:center;gap:8px;margin:4px 0">
            <div id="itemTileSpritePreview" class="small muted" style="min-width:36px;min-height:36px;display:flex;align-items:center;justify-content:center;border:1px dashed #444;padding:2px;"></div>
            <input type="file" id="itemTileSpriteUpload" accept="image/png,image/webp" style="display:none" />
            <button class="btn" type="button" id="itemTileSpriteUploadBtn">Upload Sprite</button>
          </div>
          <label><input id="itemOnMap" type="checkbox"/> On Map</label>
          <label id="itemMapWrap">Map<select id="itemMap"></select></label>
          <div class="xy" id="itemXY">
            <label>X<input id="itemX" type="number" min="0" /></label>
            <label>Y<input id="itemY" type="number" min="0" /></label>
          </div>
          <button class="btn" type="button" id="itemPick" title="Click on the map to choose location">Select on Map</button>
          <button class="btn" type="button" id="itemRemove" style="display:none">Remove from World</button>
          <div id="modsWrap" style="display:none">
            <label>Mods</label>
            <div id="modBuilder"></div>
          </div>
          <label>Equip<textarea id="itemEquip" rows="2"></textarea></label>
          <div id="itemPersonaSection" style="display:none">
            <label>Persona ID<input id="itemPersonaId" placeholder="mara.masked" /></label>
            <label>Persona Label<input id="itemPersonaLabel" placeholder="Masked persona label" /></label>
            <div class="portrait" id="itemPersonaPort"></div>
            <div class="row" style="margin:8px 0">
              <button type="button" class="pill" id="itemPersonaPrev" aria-label="Previous mask portrait">&lt;</button>
              <span class="pill">Mask Portrait</span>
              <button type="button" class="pill" id="itemPersonaNext" aria-label="Next mask portrait">&gt;</button>
            </div>
            <label>Custom Portrait<input id="itemPersonaPortraitPath" placeholder="assets/portraits/custom.png" /></label>
          </div>
          <label>Value<input id="itemValue" type="number" min="0" /></label>
          <label>Fuel<input id="itemFuel" type="number" min="0" /></label>
          <label>Use Type<select id="itemUseType"><option value="">(none)</option><option value="heal">Heal</option><option value="boost">Boost</option></select></label>
          <label id="itemUseAmtWrap" style="display:none">Heal Amount<input id="itemUseAmount" type="number" min="1" /></label>
          <label id="itemBoostStatWrap" style="display:none">Boost Stat<input id="itemBoostStat" /></label>
          <label id="itemBoostAmtWrap" style="display:none">Boost Amount<input id="itemBoostAmount" type="number" min="1" /></label>
          <label id="itemBoostDurWrap" style="display:none">Boost Duration<input id="itemBoostDuration" type="number" min="1" /></label>
          <label id="itemUseWrap" style="display:none">Use Text<textarea id="itemUse" rows="2"></textarea></label>
          <button class="btn" id="addItem">Add Item</button>
          <button class="btn" type="button" id="cancelItem" style="display:none">Cancel</button>
          <button class="btn" id="delItem" style="display:none">Delete Item</button>
          <button class="btn" type="button" id="closeItem">Done</button>
        </div>
      </fieldset>
      <fieldset class="card" id="bldgCard" data-pane="buildings" style="display:none">
        <legend>Buildings</legend>
        <div class="list" id="bldgList"></div>
        <button class="btn" type="button" id="newBldg">+ Building</button>
        <div id="bldgEditor" style="display:none">
          <div class="xy">
            <label>X<input id="bldgX" type="number" min="0" /></label>
            <label>Y<input id="bldgY" type="number" min="0" /></label>
          </div>
          <label>W<input id="bldgW" type="number" min="1" value="6" /></label>
          <label>H<input id="bldgH" type="number" min="1" value="5" /></label>
          <div id="bldgPalette">
            <button type="button" data-tile="B" style="background:#fff"></button>
            <button type="button" data-tile="D" style="background:#8bd98d"></button>
            <button type="button" data-tile="E" style="background:#000"></button>
          </div>
          <canvas id="bldgCanvas" width="192" height="160" style="margin-top:4px"></canvas>
          <label><input type="checkbox" id="bldgBunker"> Bunker</label>
          <label>Interior<select id="bldgInterior"></select></label>
          <label><input type="checkbox" id="bldgBoarded"> Boarded</label>
          <button class="btn" id="addBldg">Add Building</button>
          <button class="btn" type="button" id="cancelBldg" style="display:none">Cancel</button>
          <button class="btn" id="delBldg" style="display:none">Remove Building</button>
          <button class="btn" type="button" id="closeBldg">Done</button>
        </div>
      </fieldset>
      <fieldset class="card" id="intCard" data-pane="interiors" style="display:none">
        <legend>Interiors</legend>
        <div class="list" id="intList"></div>
        <button class="btn" type="button" id="newInterior">+ Interior</button>
        <div id="intEditor" style="display:none">
          <label>ID<input id="intId" readonly /></label>
          <label>Label<input id="intLabel" placeholder="Interior" /></label>
          <label>W<input id="intW" type="number" min="3" value="12" /></label>
          <label>H<input id="intH" type="number" min="3" value="9" /></label>
          <div id="intPalette">
            <button type="button" data-tile="W" style="background:#444"></button>
            <button type="button" data-tile="F" style="background:#222"></button>
            <button type="button" data-tile="D" style="background:#8bd98d"></button>
          </div>
          <canvas id="intCanvas" width="192" height="144" style="margin-top:4px"></canvas>
          <button class="btn" type="button" id="delInterior" style="display:none">Delete Interior</button>
          <button class="btn" type="button" id="closeInterior">Done</button>
        </div>
      </fieldset>
      <fieldset class="card" id="portalCard" data-pane="portals" style="display:none">
        <legend>Portals</legend>
        <div class="list" id="portalList"></div>
        <button class="btn" type="button" id="newPortal">+ Portal</button>
        <div id="portalEditor" style="display:none">
          <label>Map<select id="portalMap"></select></label>
          <div class="xy">
            <label>X<input id="portalX" type="number" min="0" /></label>
            <label>Y<input id="portalY" type="number" min="0" /></label>
          </div>
          <button class="btn" type="button" id="portalPick" title="Click on the map to choose location">Select on Map</button>
          <label>To Map<select id="portalToMap"></select></label>
          <div class="xy">
            <label>To X<input id="portalToX" type="number" min="0" /></label>
            <label>To Y<input id="portalToY" type="number" min="0" /></label>
          </div>
          <button class="btn" type="button" id="portalDestPick" title="Click on the map to choose destination">Pick Destination</button>
          <button class="btn" id="addPortal">Add Portal</button>
          <button class="btn" id="delPortal" style="display:none">Delete Portal</button>
        </div>
      </fieldset>
      <fieldset class="card" id="questCard" data-pane="quests" style="display:none">
        <legend>Quests</legend>
        <input id="questFilter" placeholder="Filter quests..." />
        <div class="list" id="questList"></div>
        <button class="btn" type="button" id="newQuest">+ Quest</button>
        <div id="questEditor" style="display:none">
          <label>ID<input id="questId" placeholder="quest_id" /></label>
          <label>Title<input id="questTitle" placeholder="Quest title" /></label>
          <label>Description<textarea id="questDesc" rows="2" placeholder="Quest description"></textarea></label>
          <label>Required Item/Tag<input id="questItem" /></label>
          <div id="questRewardEditor" style="margin-top:4px">
            <label>Reward Type<select id="questRewardType">
                <option value="">(none)</option>
                <option value="item">Existing Item</option>
                <option value="xp">XP</option>
                <option value="scrap">Scrap</option>
                <option value="custom">Custom Item</option>
              </select></label>
            <div id="questRewardItemWrap" style="display:none">
              <label>Item ID<input id="questRewardItemId" placeholder="sun_charm" /></label>
            </div>
            <div id="questRewardXPWrap" style="display:none">
              <label>XP Amount<input id="questRewardXP" type="number" min="0" value="0" /></label>
            </div>
            <div id="questRewardScrapWrap" style="display:none">
              <label>Scrap Amount<input id="questRewardScrap" type="number" min="0" value="0" /></label>
            </div>
            <div id="questRewardCustomWrap" style="display:none">
              <label>Custom Item ID<input id="questRewardCustomId" placeholder="reward_id" /></label>
              <label>Name<input id="questRewardCustomName" placeholder="Reward name" /></label>
              <label>Type<select id="questRewardCustomType">
                  <option value=""></option>
                  <option value="weapon">Weapon</option>
                  <option value="armor">Armor</option>
                  <option value="trinket">Trinket</option>
                  <option value="consumable">Consumable</option>
                  <option value="quest">Quest</option>
                  <option value="misc">Misc</option>
                </select></label>
              <label>Slot<select id="questRewardCustomSlot">
                  <option value=""></option>
                  <option value="weapon">Weapon</option>
                  <option value="armor">Armor</option>
                  <option value="trinket">Trinket</option>
                </select></label>
              <div id="questRewardModsWrap" style="margin-top:4px">
                <label>Mods</label>
                <div id="questRewardMods"></div>
              </div>
            </div>
          </div>
          <label>XP Reward<input id="questXP" type="number" min="10" max="100" value="10" /></label>
          <label>NPC<select id="questNPC">
              <option value="">(none)</option>
            </select></label>
          <button class="btn" id="addQuest">Add Quest</button>
          <button class="btn" id="delQuest" style="display:none">Delete Quest</button>
        </div>
      </fieldset>
      <fieldset class="card" id="eventCard" data-pane="events" style="display:none">
        <legend>Tile Events</legend>
        <input id="eventFilter" placeholder="Filter events..." />
        <div class="list" id="eventList"></div>
        <button class="btn" type="button" id="newEvent">+ Event</button>
        <div id="eventEditor" style="display:none">
          <label>Map<select id="eventMap"></select></label>
          <div class="xy">
            <label>X<input id="eventX" type="number" min="0" /></label>
            <label>Y<input id="eventY" type="number" min="0" /></label>
          </div>
          <button class="btn" type="button" id="eventPick" title="Click on the map to choose location">Select on Map</button>
          <label>Effect<select id="eventEffect">
              <option value="toast">Toast</option>
              <option value="log">Log</option>
              <option value="addFlag">Add Flag</option>
              <option value="modStat">Mod Stat</option>
            </select></label>
          <label id="eventMsgWrap">Message<input id="eventMsg" placeholder="Event message" /></label>
          <label id="eventFlagWrap" style="display:none">Flag<input id="eventFlag" /></label>
          <div id="eventStatWrap" style="display:none">
            <label>Stat<select id="eventStat"></select></label>
            <label>Delta<input id="eventDelta" type="number" /></label>
            <label>Duration<input id="eventDuration" type="number" min="0" /></label>
          </div>
        <button class="btn" id="addEvent">Add Event</button>
        <button class="btn" id="delEvent" style="display:none">Delete Event</button>
      </div>
    </fieldset>
      <fieldset class="card" id="arenaCard" data-pane="arenas" style="display:none">
        <legend>Arenas</legend>
        <input id="arenaFilter" placeholder="Filter arenas..." />
        <div class="list" id="arenaList"></div>
        <button class="btn" type="button" id="newArena">+ Arena</button>
        <div id="arenaEditor" style="display:none">
          <label>Map<select id="arenaMap"></select></label>
          <label>Bank ID<input id="arenaBankId" placeholder="Defaults to map id" /></label>
          <label>Entrance Delay (ms)<input id="arenaDelay" type="number" min="0" /></label>
          <label>Reset Log<textarea id="arenaResetLog" rows="2"></textarea></label>
          <label>Reward Log<textarea id="arenaRewardLog" rows="2"></textarea></label>
          <label>Reward Toast<input id="arenaRewardToast" /></label>
          <div id="arenaWaveContainer"></div>
          <button class="btn" type="button" id="arenaAddWave">+ Wave</button>
          <div class="btn-group">
            <button class="btn btn--primary" id="addArena">Add Arena</button>
            <button class="btn" type="button" id="cancelArena" style="display:none">Cancel</button>
            <button class="btn" id="delArena" style="display:none">Delete Arena</button>
          </div>
        </div>
      </fieldset>
      <fieldset class="card" id="zoneCard" data-pane="zones" style="display:none">
        <legend>Zones</legend>
        <div class="list" id="zoneList"></div>
        <button class="btn" type="button" id="newZone">+ Zone</button>
        <div id="zoneEditor" style="display:none">
          <label>Map<select id="zoneMap"></select></label>
          <label>Tag<input id="zoneTag" /></label>
          <div class="xy">
            <label>X<input id="zoneX" type="number" min="0" /></label>
            <label>Y<input id="zoneY" type="number" min="0" /></label>
          </div>
          <label>W<input id="zoneW" type="number" min="1" value="1" /></label>
          <label>H<input id="zoneH" type="number" min="1" value="1" /></label>
          <label>HP/Step<input id="zoneHp" type="number" /></label>
          <label>Message<input id="zoneMsg" /></label>
          <label>Weather<input id="zoneWeather" /></label>
          <label>Negate<input id="zoneNegate" /></label>
          <label>Heal Mult<input id="zoneHealMult" type="number" step="0.1" min="0" /></label>
          <label><input type="checkbox" id="zoneNoEnc" />No Encounters</label>
          <label>Use Item<input id="zoneUseItem" /></label>
          <label>Reward<input id="zoneReward" /></label>
          <label><input type="checkbox" id="zoneOnce" />Once</label>
          <label><input type="checkbox" id="zoneWalled" />Walled</label>
          <div id="zoneEntrancesWrap" style="display:none;margin-left:8px;">
            <label><input type="checkbox" id="zoneEntranceNorth" />North Entrance</label>
            <label><input type="checkbox" id="zoneEntranceSouth" />South Entrance</label>
            <label><input type="checkbox" id="zoneEntranceEast" />East Entrance</label>
            <label><input type="checkbox" id="zoneEntranceWest" />West Entrance</label>
          </div>
          <button class="btn" id="addZone">Add Zone</button>
          <button class="btn" id="delZone" style="display:none">Delete Zone</button>
        </div>
      </fieldset>
      <fieldset class="card" id="encounterCard" data-pane="encounters" style="display:none">
        <legend>Encounters</legend>
        <input id="encFilter" placeholder="Filter encounters..." />
        <div class="list" id="encounterList"></div>
        <button class="btn" type="button" id="newEncounter">+ Enemy</button>
        <div id="encounterEditor" style="display:none">
          <label>Map<select id="encMap"></select></label>
          <label>Location<select id="encLocationMode">
            <option value="distance">Distance from road</option>
            <option value="zone">Zone tag</option>
          </select></label>
          <label>Template<select id="encTemplate"></select></label>
          <label>Min Dist<input id="encMinDist" type="number" min="0" /></label>
          <label>Max Dist<input id="encMaxDist" type="number" min="0" /></label>
          <label id="encZoneWrap">Zone<select id="encZone"></select></label>
          <div class="lootTableWrap">
            <div class="lootTableLabel">Loot Table</div>
            <div class="lootTableHeader"><span>Item</span><span>Chance %</span></div>
            <div id="encLootTable" class="lootTable"></div>
            <button class="btn" type="button" id="encAddLootRow">+ Loot Entry</button>
          </div>
          <button class="btn" id="addEncounter">Add Enemy</button>
          <button class="btn" type="button" id="cancelEncounter" style="display:none">Cancel</button>
          <button class="btn" id="delEncounter" style="display:none">Delete Enemy</button>
          <button class="btn" type="button" id="closeEncounter">Done</button>
        </div>
      </fieldset>
      <fieldset class="card" id="templateCard" data-pane="templates" style="display:none">
        <legend>NPC Templates <span class="help" title="Templates for enemies that can spawn from dialog">(?)</span></legend>
        <div class="list" id="templateList"></div>
        <button class="btn" type="button" id="newTemplate">+ Template</button>
        <div id="templateEditor" style="display:none">
          <label>ID<input id="templateId" /></label>
          <label>Name<input id="templateName" /></label>
          <label>Description<textarea id="templateDesc" rows="2"></textarea></label>
          <label>Color<input id="templateColor" type="color" value="#9ef7a0" /></label>
          <label>Portrait<input id="templatePortrait" /></label>
          <label>HP<input id="templateHP" type="number" min="1" value="5" /></label>
          <label>ATK<input id="templateATK" type="number" min="1" value="1" /></label>
          <label>DEF<input id="templateDEF" type="number" min="0" value="0" /></label>
          <label>Challenge (1-10)<span class="help" title="Higher values improve loot cache drops">(?)</span><input id="templateChallenge" type="number" min="1" max="10" /></label>
          <label>Special Cue<input id="templateSpecialCue" /></label>
          <label>Special Dmg<input id="templateSpecialDmg" type="number" min="1" /></label>
          <div class="lootTableWrap">
            <div class="lootTableLabel">Loot Table</div>
            <div class="lootTableHeader"><span>Item</span><span>Chance %</span></div>
            <div id="templateLootTable" class="lootTable"></div>
            <button class="btn" type="button" id="templateAddLootRow">+ Loot Entry</button>
          </div>
          <label>Drop Scrap<input id="templateDropScrap" type="checkbox" /></label>
          <label class="templateScrapField" style="display:none">Scrap %<input id="templateScrapChance" type="number" min="0" max="100" value="100" /></label>
          <label class="templateScrapField" style="display:none">Min Scrap<input id="templateScrapMin" type="number" min="0" value="1" /></label>
          <label class="templateScrapField" style="display:none">Max Scrap<input id="templateScrapMax" type="number" min="0" value="1" /></label>
          <label>Requires<input id="templateRequires" /></label>
        <button class="btn" id="addTemplate">Add Template</button>
        <button class="btn" id="delTemplate" style="display:none">Delete Template</button>
      </div>
      </fieldset>
      <fieldset class="card" id="wizardCard" data-pane="wizards" style="display:none">
        <legend>Wizards</legend>
        <div id="wizardList"></div>
      </fieldset>
      </div><!-- /.tabpanes -->
    </aside>
  </div><!-- /.ak-layout -->
  <div id="loadModal" class="modal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><b>Load Module</b></div>
        <button class="btn" type="button" id="closeLoadModal">Close</button>
      </div>
      <div id="loadDropZone" role="button" tabindex="0" aria-label="Load module JSON">
        <div style="font-weight:bold;margin-bottom:4px">Drop a module JSON file</div>
        <div style="font-size:0.9rem">Or browse to pick a saved module.</div>
      </div>
      <div id="loadModalActions">
        <div id="loadStatus" class="inline-hint" aria-live="polite"></div>
        <button class="btn btn--primary" type="button" id="browseLoadFile">Browse</button>
      </div>
      <input type="file" id="loadFile" accept="application/json" style="display:none" />
    </div>
  </div>
  <div id="dialogModal" class="modal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><b>Dialog Tree Editor</b></div>
        <button class="btn" type="button" id="closeDialogModal">Close</button>
      </div>
      <div id="treeEditor"></div>
      <div id="treeWarning" style="color:#fc0;font-size:0.75rem;margin-top:4px"></div>
      <button class="btn" type="button" id="addNode">Add Node</button>
      <datalist id="choiceFlagList"></datalist>
    </div>
  </div>
  <div id="wizardModal" class="modal">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><b id="wizardTitle"></b></div>
        <button class="btn" type="button" id="closeWizard">Close</button>
      </div>
      <div id="wizardBody"></div>
      <div style="margin-top:8px;text-align:right">
        <button class="btn" type="button" id="wizardPrev">Back</button>
        <button class="btn" type="button" id="wizardNext">Next</button>
      </div>
    </div>
  </div>
  <div id="confirmModal" class="modal">
    <div class="card" style="padding:12px;text-align:center">
      <div id="confirmText" style="margin-bottom:8px"></div>
      <div>
        <button class="btn" id="confirmYes">Yes</button>
        <button class="btn" id="confirmNo">Cancel</button>
      </div>
    </div>
  </div>
    <div id="quickActions" class="quick-actions" role="toolbar" aria-label="Quick actions">
      <div id="serverModeActions" class="quick-actions__cloud" hidden>
        <span class="quick-actions__cloud-status" data-role="server-mode-status" aria-live="polite"></span>
        <button class="btn" type="button" aria-haspopup="dialog">‚òÅ Cloud</button>
      </div>
      <button id="quickSave" class="btn" type="button" title="Save module (Ctrl+S)">üíæ Save</button>
      <button id="cloudLoad" class="btn" type="button" title="Load the latest cloud draft" hidden>‚òÅ Load</button>
      <button id="cloudSave" class="btn" type="button" title="Save to the cloud" hidden>‚òÅ Save</button>
      <button id="cloudPublish" class="btn" type="button" title="Publish for everyone" hidden>üì¢ Publish</button>
      <button id="cloudShare" class="btn" type="button" title="Share with collaborators" hidden>üîó Share</button>
      <span id="cloudActionStatus" class="quick-actions__status" aria-live="polite" hidden></span>
      <button id="playtestFloat" class="btn btn--primary" type="button" title="Playtest module (Ctrl+P)">‚ñ∂ Playtest</button>
    </div>
  <script defer src="./scripts/event-bus.js"></script>
  <script defer src="./scripts/supporting/chiptune.js"></script>
  <script defer src="./scripts/core/effects.js"></script>
  <script defer src="./scripts/core/module-behaviors.js"></script>
  <script defer src="./scripts/core/inventory.js"></script>
  <script defer src="./scripts/core/actions.js"></script>
  <script defer src="./scripts/core/movement.js"></script>
  <script defer src="./scripts/core/dialog.js"></script>
  <script defer src="./scripts/core/combat.js"></script>
  <script defer src="./scripts/core/party.js"></script>
  <script defer src="./scripts/core/quests.js"></script>
    <script defer src="./scripts/core/npc.js"></script>
    <script defer src="./scripts/dustland-core.js"></script>
    <script defer src="./scripts/core/event-flags.js"></script>
    <script defer src="./scripts/core/loop.js"></script>
    <script defer src="./scripts/dustland-path.js"></script>
    <script defer src="./scripts/dustland-nano.js"></script>
    <script defer src="./scripts/dustland-engine.js"></script>
    <script defer src="./components/wizard/wizard.js"></script>
    <script defer src="./components/wizard/steps/text.js"></script>
    <script defer src="./components/wizard/steps/asset-picker.js"></script>
    <script defer src="./components/wizard/steps/map-placement.js"></script>
    <script defer src="./components/wizard/steps/item-picker.js"></script>
    <script defer src="./components/wizard/steps/tilemap-picker.js"></script>
    <script defer src="./components/wizard/steps/door-linker.js"></script>
    <script defer src="./components/wizard/steps/confirm.js"></script>
    <script defer src="./components/wizard/npc-wizard.js"></script>
    <script defer src="./scripts/supporting/wizard-building.js"></script>
    <script defer src="./scripts/procedural-map.js"></script>
    <script>
      (function loadServerModeModules() {
        let dynamicImportsBroken = false;
        const shouldSkipError = (error) => {
          if (error?.code === 'ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING') {
            dynamicImportsBroken = true;
            return true;
          }
          return false;
        };
        const importWithWarning = (path) => {
          if (dynamicImportsBroken) return Promise.resolve();
          try {
            return import(path).catch((error) => {
              if (shouldSkipError(error)) return;
              console.warn(`Unable to load ${path}.`, error);
            });
          } catch (error) {
            if (!shouldSkipError(error)) {
              console.warn(`Unable to load ${path}.`, error);
            }
            return Promise.resolve();
          }
        };
        void importWithWarning('./scripts/ack/server-mode-controls.js');
        void importWithWarning('./scripts/ack/cloud-actions.js');
      })();
    </script>
    <script defer src="./scripts/adventure-kit.js"></script>
  </body>

</html>
